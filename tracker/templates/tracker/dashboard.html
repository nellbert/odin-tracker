{% extends 'base.html' %}
{% load static %}
{% load template_filters %}

{% block title %}Dashboard - OdinTrack{% endblock %}

{# Add Toastify CSS #}
{% block extra_head %}
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
<style>
    /* New Toastify appearance for glassmorphism and bottom-right positioning */
    .toastify {
        padding: 12px 20px !important;
        border-radius: 12px !important; 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif !important;
        color: var(--text-color, #e0e0e0) !important; /* Light text for dark glass */
        background: var(--glass-card-bg-toast, rgba(30, 30, 30, 0.65)) !important; /* Darker, more translucent for toasts */
        backdrop-filter: blur(var(--glass-card-blur-toast, 12px)) saturate(var(--glass-card-saturate-toast, 160%)) !important;
        border: 1px solid var(--glass-card-border-color-toast, rgba(255, 255, 255, 0.1)) !important; /* Lighter border */
        box-shadow: 0 5px 20px rgba(0,0,0,0.3) !important; /* Adjusted shadow */
        opacity: 0.95 !important; /* Slight transparency if not fully handled by background */
        z-index: 99999 !important; /* Ensure it's on top */
    }

    /* Toastify will handle actual positioning via JS options gravity:'bottom', position:'right' */
    /* Remove specific top override if it was present */
    /* .toastify.on.toastify-top { top: 15px; } */ /* Example of what to ensure is not conflicting or is removed */
    
    /* Custom classes for themed success/error states */
    .toastify.toast-success-theme {
        border-left: 4px solid var(--bs-success-rgb, 25, 135, 84) !important; /* Using Bootstrap's success color variable if available */
        /* background: rgba(var(--bs-success-rgb), 0.1) !important; /* Optional subtle background tint */
    }

    .toastify.toast-error-theme {
        border-left: 4px solid var(--bs-danger-rgb, 220, 53, 69) !important; /* Using Bootstrap's danger color variable */
    }

    /* Ensure close button is visible on the glass background */
    .toastify .toastify-close {
        opacity: 0.7 !important;
        color: var(--text-color, #e0e0e0) !important; 
        text-shadow: none !important; /* Remove default text-shadow if any */
    }
    .toastify .toastify-close:hover {
        opacity: 1 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4 px-lg-4" id="dashboard-content">
    <div class="row g-4">

        {# === Main Content Column === #}
        <div class="col-lg-7 order-2 order-lg-1">
            <div class="glass-card p-3 p-md-4 mb-4">
                <h3 class="mb-4 text-center text-lg-start"><i class="fas fa-book-reader me-2"></i>Course Content</h3>
                {% for section in sections %}
                    <div class="glass-card mb-4 section-card"> {# Nested glass-card for each section #}
                        <div class="card-header bg-transparent border-bottom-0 pt-3 pb-2">
                            <h5 class="mb-0 section-title">{{ section.title }}</h5>
                        </div>
                        <div class="card-body p-0"> 
                            <ul class="list-group list-group-flush lesson-list">
                                {% for lesson in section.lessons.all %}
                                    <li id="lesson-item-{{ lesson.id }}" class="list-group-item lesson-item d-flex justify-content-between align-items-center {% if lesson.id in completed_lessons %}completed-lesson{% endif %}">
                                        <div class="flex-grow-1 me-3">
                                            <span class="lesson-type-badge me-2 rounded-pill px-2 py-1 small
                                                {% if lesson.lesson_type == 'Project' %}bg-warning text-dark{% else %}bg-info text-dark{% endif %}">
                                                <i class="fas {% if lesson.lesson_type == 'Project' %}fa-file-code{% else %}fa-chalkboard-teacher{% endif %} me-1"></i>
                                                {{ lesson.lesson_type }}
                                            </span>

                                            {% if lesson.url %}
                                                <a href="{{ lesson.url }}" target="_blank" class="lesson-title-link text-decoration-none {% if lesson.id in completed_lessons %}text-muted{% else %}text-dark{% endif %}">
                                                    {{ lesson.title }}
                                                </a>
                                            {% else %}
                                                <span class="lesson-title-link {% if lesson.id in completed_lessons %}text-muted{% else %}text-dark{% endif %}">{{ lesson.title }}</span>
                                            {% endif %}
                                            <small class="text-muted d-block d-sm-inline mt-1 mt-sm-0 ms-1"> ({{ lesson.points_value }} pts)</small>
                                        </div>

                                        <div class="text-end lesson-actions">
                                            {% csrf_token %} {# Get token once for JS #}
                                            <input type="hidden" id="csrfTokenInput" value="{{ csrf_token }}">

                                            {% if lesson.id in completed_lessons %}
                                                <button type="button" 
                                                        class="btn btn-sm btn-outline-success completed-btn lesson-toggle-btn" 
                                                        title="Mark as Incomplete"
                                                        data-lesson-id="{{ lesson.id }}"
                                                        data-action-url="/tracker/unmark_complete/{{ lesson.id }}/"
                                                        data-current-status="completed">
                                                    <i class="fas fa-check-circle me-1"></i> Completed
                                                </button>
                                            {% else %}
                                                <button type="button" 
                                                        class="btn btn-sm btn-primary mark-complete-btn lesson-toggle-btn" 
                                                        data-lesson-id="{{ lesson.id }}"
                                                        data-action-url="/tracker/mark_complete/{{ lesson.id }}/"
                                                        data-current-status="incomplete">
                                                    <i class="fas fa-check me-1"></i>Mark Complete
                                                </button>
                                            {% endif %}
                                        </div>
                                    </li>
                                {% empty %}
                                    <li class="list-group-item text-muted">No lessons in this section yet.</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                {% empty %}
                    <div class="glass-card p-4 text-center">
                        <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No course sections found. Add some in the <a href="{% url 'admin:index' %}">admin interface</a>!</p>
                    </div>
                {% endfor %}
            </div>
        </div>

        {# === Sidebar Column === #}
        <div class="col-lg-5 order-1 order-lg-2">
            
            {# Stats Card - Add IDs to elements for easier JS targeting #}
            <div class="glass-card p-3 p-md-4 mb-4 text-center">
                <h4 class="mb-3"><i class="fas fa-chart-line me-2"></i>Progress & Stats</h4>
                <div class="row mb-3 align-items-center">
                    <div class="col-6 border-end border-light">
                        <h5 class="stat-title">Overall Progress</h5>
                        <p id="lesson-progress-text" class="mb-1 text-muted">({{ user_completed_count }}/{{ total_lessons_count }} lessons)</p>
                        <div class="progress mb-2" id="overall-progress-bar-container" role="progressbar" aria-label="Course Progress" aria-valuenow="{{ progress_percentage }}" aria-valuemin="0" aria-valuemax="100" style="height: 12px;">
                            <div id="overall-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: {{ progress_percentage }}%">{{ progress_percentage }}%</div>
                        </div>
                        <p class="mb-0"><strong>Points:</strong> <span id="total-points-display" class="badge bg-primary rounded-pill fs-6">{{ total_points }}</span></p>
                    </div>
                    <div class="col-6">
                        <h5 class="stat-title"><i class="fas fa-fire me-1 text-danger"></i>Streaks</h5>
                        <p class="mb-1">
                            <strong>Current:</strong> <span id="current-streak-display" class="badge bg-success rounded-pill fs-6">{{ current_streak }} Day{{ current_streak|pluralize }}</span>
                        </p>
                        <p class="mb-0">
                            <strong>Longest:</strong> <span id="longest-streak-display" class="badge bg-info rounded-pill fs-6">{{ longest_streak }} Day{{ longest_streak|pluralize }}</span>
                        </p>
                        <small id="last-activity-display" class="text-muted d-block mt-1">Last active: {{ last_activity_date_str }}</small>
                    </div>
                </div>
            </div>

            {# Daily Challenge Card - Add IDs/classes for JS targeting #}
            <div id="daily-challenge-card" class="glass-card p-3 p-md-4 mb-4 {% if not user_daily_challenge.challenge %}d-none{% endif %}"> {# Hide if no challenge object initially #}
                <h4 class="text-center mb-3">
                    <i class="fas fa-bullseye-pointer me-2 text-danger"></i>Daily Challenge
                    <span id="daily-challenge-completed-badge" class="badge bg-success rounded-pill ms-2 fs-6 {% if not user_daily_challenge.is_completed %}d-none{% endif %}">
                        <i class="fas fa-check-circle me-1"></i>Completed!
                    </span>
                </h4>
                <div class="text-center">
                    <h5 id="daily-challenge-description" class="challenge-description">{{ user_daily_challenge.challenge.get_description|default:"No challenge today" }}</h5>
                    <div id="daily-challenge-progress-area" class="{% if user_daily_challenge.is_completed %}d-none{% endif %}"> {# Hide progress if completed #}
                        <p id="daily-challenge-progress-text" class="mb-1 text-muted">
                            Progress: {{ user_daily_challenge.current_progress|default:0 }} / {{ user_daily_challenge.challenge.target_value|default:1 }}
                        </p>
                        <div id="daily-challenge-progress-bar-container" class="progress mx-auto mb-2" style="max-width: 300px; height: 10px;" role="progressbar" 
                             aria-valuenow="{{ user_daily_challenge.current_progress|default:0 }}" 
                             aria-valuemin="0" 
                             aria-valuemax="{{ user_daily_challenge.challenge.target_value|default:1 }}">
                            <div id="daily-challenge-progress-bar" class="progress-bar bg-danger progress-bar-striped progress-bar-animated" 
                                 style="width: {% widthratio user_daily_challenge.current_progress user_daily_challenge.challenge.target_value 100 %}%" ></div>
                        </div>
                        <small id="daily-challenge-reward-text" class="text-muted">Bonus: <span class="fw-bold">{{ user_daily_challenge.challenge.points_reward|default:0 }}</span> points</small>
                    </div>
                    <div id="daily-challenge-completed-message" class="{% if not user_daily_challenge.is_completed %}d-none{% endif %}"> {# Show message if completed #}
                         <p class="text-success"><i class="fas fa-gift me-1"></i>+{{ user_daily_challenge.challenge.points_reward|default:0 }} bonus points earned!</p>
                    </div>
                </div>
            </div>
            {# Placeholder for when there is NO challenge object at all #}
             <div id="no-daily-challenge-card" class="glass-card p-3 p-md-4 mb-4 text-center {% if user_daily_challenge.challenge %}d-none{% endif %}">
                <h4 class="mb-2"><i class="fas fa-calendar-day me-2 text-muted"></i>Daily Challenge</h4>
                <p class="text-muted">Check back tomorrow for a new challenge!</p>
            </div>

            {# Recently Unlocked Achievements Section - Minor style consistency check #}
            {% if user_achievements %}
            <div class="glass-card p-3 p-md-4 mb-4">
                <h4 class="text-center mb-4"><i class="fas fa-medal me-2 text-warning"></i>Recent Achievements</h4>
                <div class="row g-2 justify-content-center">
                    {% for user_ach in user_achievements %}
                        <div class="col-auto achievement-item" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ user_ach.achievement.description }} ({{ user_ach.achievement.points_reward }} pts) - Awarded: {{ user_ach.awarded_at|date:'M d, Y' }}">
                            <div class="text-center p-2 border rounded-pill" style="background-color: rgba(255,255,255,0.05);">
                                <i class="{{ user_ach.achievement.icon_class|default:'fas fa-star' }} fa-2x mb-1" style="color: var(--bs-warning);"></i>
                                <small class="d-block text-muted achievement-title">{{ user_ach.achievement.title }}</small>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {# Live User Stats Section - Revamped #}
            <div class="glass-card p-3 p-md-4 mb-4">
                <h4 class="text-center mb-3"><i class="fas fa-users me-2"></i>Live Standings</h4>
                <div id="user-stats-live-dashboard" class="live-standings-list">
                    <p class="text-center text-muted loading-stats">Loading live standings...</p>
                    {# User stats will be populated here by WebSocket, styled like compact leaderboard entries #}
                </div>
            </div>

        </div> {# End Sidebar Column #}
    </div> {# End Row #}
</div> {# End Container #}

{# Tooltip script remains the same #}
<script>
document.addEventListener('DOMContentLoaded', function () {
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl)
  })
});
</script>

{# WebSocket JavaScript - Adapted for new live stats container #}
<script>
    const liveStandingsList = document.getElementById('user-stats-live-dashboard');

    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
    const wsPath = wsScheme + '://' + window.location.host + '/ws/live_stats/';

    console.log("Connecting to Dashboard WebSocket at:", wsPath);
    const dashboardSocket = new WebSocket(wsPath);

    dashboardSocket.onopen = function(e) {
        console.log("Dashboard WebSocket connection established");
    };

    dashboardSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        console.log("Dashboard message from server:", data);

        if (data.type === 'full_stats_load' || data.type === 'stats_update') {
            updateLiveStandings(data.stats);
        }
    };

    dashboardSocket.onclose = function(e) {
        console.error('Dashboard WebSocket connection closed unexpectedly:', e);
        if (liveStandingsList) {
            liveStandingsList.innerHTML = '<p class="text-center text-danger p-3">Live standings connection lost. Please refresh.</p>';
        }
    };

    dashboardSocket.onerror = function(err) {
        console.error('Dashboard WebSocket error:', err);
        if (liveStandingsList) {
            liveStandingsList.innerHTML = '<p class="text-center text-warning p-3">Could not connect to live standings.</p>';
        }
    };

    function updateLiveStandings(stats) {
        if (!liveStandingsList) return;
        liveStandingsList.innerHTML = ''; // Clear previous entries

        if (stats && stats.length > 0) {
            // Determine current user for highlighting
            const currentUsername = "{{ request.user.username }}"; 

            stats.slice(0, 5).forEach((userStat, index) => { // Show top 5 for example
                const entryDiv = document.createElement('div');
                entryDiv.classList.add('live-standing-entry', 'glass-card', 'p-2', 'mb-2');
                if (userStat.username === currentUsername) {
                    entryDiv.classList.add('current-user-highlight-dashboard');
                }

                // Add special styling for top 1 if desired
                if (index === 0) {
                    entryDiv.classList.add('rank-1-dashboard');
                }

                entryDiv.innerHTML = `
                    <div class="row g-2 align-items-center">
                        <div class="col-auto rank-display-dashboard">
                            <span class="fw-bold fs-5">${index + 1}</span>
                        </div>
                        <div class="col username-dashboard">
                            <span class="fw-semibold">${userStat.username}</span>
                        </div>
                        <div class="col-auto points-dashboard">
                            <span class="badge bg-primary rounded-pill">
                                <i class="fas fa-star me-1"></i>${userStat.points}
                            </span>
                        </div>
                    </div>
                `;
                liveStandingsList.appendChild(entryDiv);
            });
             // Remove "Loading..." text
            const loadingP = liveStandingsList.querySelector('.loading-stats');
            if(loadingP) loadingP.remove();

        } else {
            liveStandingsList.innerHTML = '<p class="text-center text-muted p-3">No live standings available yet.</p>';
        }
    }
</script>

{# Add custom toast container #}
<div id="custom-toast-container" style="position: fixed; bottom: 2.5rem; right: 2.5rem; z-index: 1055; display: flex; flex-direction: column; gap: 1rem; align-items: flex-end;"></div>

{# Updated AJAX script for lesson completion with full context update & toasts #}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dashboardContent = document.getElementById('dashboard-content');
    const csrfToken = document.getElementById('csrfTokenInput').value;

    // Function to display toast messages
    function showCustomToast(message, type = 'success') {
        // type: 'success', 'error', 'info', 'warning'
        const container = document.getElementById('custom-toast-container');
        if (!container) return;
        // Icon selection
        let iconClass = 'fa-circle-info';
        let colorClass = 'bg-primary';
        if (type === 'success') { iconClass = 'fa-check-circle'; colorClass = 'bg-success'; }
        else if (type === 'error') { iconClass = 'fa-times-circle'; colorClass = 'bg-danger'; }
        else if (type === 'warning') { iconClass = 'fa-exclamation-triangle'; colorClass = 'bg-warning text-dark'; }
        // Toast element
        const toast = document.createElement('div');
        toast.className = `glass-card custom-toast shadow-lg d-flex align-items-center ${colorClass}`;
        toast.style.minWidth = '260px';
        toast.style.maxWidth = '350px';
        toast.style.padding = '1rem 1.5rem';
        toast.style.borderRadius = '18px';
        toast.style.backdropFilter = 'blur(14px) saturate(160%)';
        toast.style.border = '1.5px solid rgba(255,255,255,0.13)';
        toast.style.fontSize = '1rem';
        toast.style.color = type === 'warning' ? '#222' : '#fff';
        toast.style.display = 'flex';
        toast.style.alignItems = 'center';
        toast.style.gap = '0.75rem';
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(30px)';
        toast.style.transition = 'opacity 0.3s, transform 0.3s';
        toast.innerHTML = `
            <i class="fas ${iconClass} fa-lg me-2"></i>
            <span style="flex:1;">${message}</span>
            <button type="button" class="btn-close btn-close-white ms-2" aria-label="Close" style="filter: drop-shadow(0 0 2px #0008); opacity:0.7;"></button>
        `;
        // Close button
        toast.querySelector('button').onclick = () => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateY(30px)';
            setTimeout(() => toast.remove(), 300);
        };
        // Add and animate in
        container.appendChild(toast);
        setTimeout(() => {
            toast.style.opacity = '1';
            toast.style.transform = 'translateY(0)';
        }, 10);
        // Auto-remove after 3s
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateY(30px)';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // Function to update dashboard elements based on context data
    function updateDashboardUI(context) {
        // Update Points
        const pointsDisplay = document.getElementById('total-points-display');
        if (pointsDisplay) pointsDisplay.textContent = context.total_points;

        // Update Progress Bar & Text
        const progressText = document.getElementById('lesson-progress-text');
        if (progressText) progressText.textContent = `(${context.user_completed_count}/${context.total_lessons_count} lessons)`;
        const progressBar = document.getElementById('overall-progress-bar');
        if (progressBar) {
            progressBar.style.width = `${context.progress_percentage}%`;
            progressBar.textContent = `${context.progress_percentage}%`;
            progressBar.setAttribute('aria-valuenow', context.progress_percentage);
        }

        // Update Streaks
        const currentStreak = document.getElementById('current-streak-display');
        if (currentStreak) currentStreak.textContent = `${context.current_streak} Day${context.current_streak !== 1 ? 's' : ''}`;
        const longestStreak = document.getElementById('longest-streak-display');
        if (longestStreak) longestStreak.textContent = `${context.longest_streak} Day${context.longest_streak !== 1 ? 's' : ''}`;
        const lastActivity = document.getElementById('last-activity-display');
        if (lastActivity) lastActivity.textContent = `Last active: ${context.last_activity_date_str}`;

        // Update Daily Challenge Card
        const challengeCard = document.getElementById('daily-challenge-card');
        const noChallengeCard = document.getElementById('no-daily-challenge-card');
        if (challengeCard && noChallengeCard) {
            if (context.daily_challenge) {
                challengeCard.classList.remove('d-none');
                noChallengeCard.classList.add('d-none');

                const desc = document.getElementById('daily-challenge-description');
                const progressArea = document.getElementById('daily-challenge-progress-area');
                const progressTextEl = document.getElementById('daily-challenge-progress-text');
                const progressBarCont = document.getElementById('daily-challenge-progress-bar-container');
                const progressBarEl = document.getElementById('daily-challenge-progress-bar');
                const rewardText = document.getElementById('daily-challenge-reward-text');
                const completedBadge = document.getElementById('daily-challenge-completed-badge');
                const completedMsg = document.getElementById('daily-challenge-completed-message');

                if (desc) desc.textContent = context.daily_challenge.description;
                if (rewardText) rewardText.innerHTML = `Bonus: <span class="fw-bold">${context.daily_challenge.points_reward}</span> points`;

                if (context.daily_challenge.is_completed) {
                    if (progressArea) progressArea.classList.add('d-none');
                    if (completedBadge) completedBadge.classList.remove('d-none');
                    if (completedMsg) completedMsg.classList.remove('d-none');
                    if (completedMsg) completedMsg.innerHTML = `<p class="text-success"><i class="fas fa-gift me-1"></i>+${context.daily_challenge.points_reward} bonus points earned!</p>`;
                } else {
                    if (progressArea) progressArea.classList.remove('d-none');
                    if (completedBadge) completedBadge.classList.add('d-none');
                    if (completedMsg) completedMsg.classList.add('d-none');
                    
                    if(progressTextEl) progressTextEl.textContent = `Progress: ${context.daily_challenge.current_progress} / ${context.daily_challenge.target_value}`;
                    if(progressBarCont) progressBarCont.setAttribute('aria-valuenow', context.daily_challenge.current_progress);
                    if(progressBarCont) progressBarCont.setAttribute('aria-valuemax', context.daily_challenge.target_value);
                    if(progressBarEl) {
                        const challengeProgressPercent = context.daily_challenge.target_value > 0 
                            ? (context.daily_challenge.current_progress / context.daily_challenge.target_value) * 100 
                            : 0;
                        progressBarEl.style.width = `${Math.min(challengeProgressPercent, 100)}%`; // Cap at 100%
                    }
                }
            } else { // No active challenge for today
                challengeCard.classList.add('d-none');
                noChallengeCard.classList.remove('d-none');
            }
        }
        // Note: Updating recent achievements would require more data in context or a separate request
    }

    if (dashboardContent) {
        dashboardContent.addEventListener('click', function(event) {
            const button = event.target.closest('.lesson-toggle-btn');
            if (!button) return;
            event.preventDefault();

            const lessonId = button.dataset.lessonId;
            const actionUrl = button.dataset.actionUrl;
            const currentStatus = button.dataset.currentStatus;
            const listItem = document.getElementById(`lesson-item-${lessonId}`);
            const actionsContainer = button.parentElement;

            if (!lessonId || !actionUrl || !listItem || !actionsContainer) {
                console.error('Missing data attributes or elements for lesson toggle.');
                return;
            }

            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Saving...';
            const isCompleting = currentStatus === 'incomplete';
            if (isCompleting) {
                listItem.classList.add('completed-lesson');
            } else {
                listItem.classList.remove('completed-lesson');
            }

            fetch(actionUrl, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json'
                },
            })
            .then(response => {
                const contentType = response.headers.get('content-type');
                if (!response.ok) {
                    if (contentType && contentType.includes('application/json')) {
                        return response.json().then(errData => {
                            throw new Error(errData.message || `Request failed with status ${response.status}`);
                        });
                    } else {
                        // It's not JSON, so don't try to parse it as JSON.
                        return response.text().then(textData => {
                             throw new Error(`Server returned non-JSON error (status ${response.status}). Response starts with: ${textData.substring(0,150)}...`);
                        });
                    }
                }
                // For successful responses, we still expect JSON
                if (contentType && contentType.includes('application/json')) {
                    return response.json();
                } else {
                    return response.text().then(textData => {
                        throw new Error(`Expected JSON from server for a successful response, but got non-JSON. Response starts with: ${textData.substring(0,150)}...`);
                    });
                }
            })
            .then(data => {
                if (data.status === 'ok') {
                    // Update button UI
                    if (isCompleting) {
                        actionsContainer.innerHTML = `
                            <button type="button" 
                                    class="btn btn-sm btn-outline-success completed-btn lesson-toggle-btn" 
                                    title="Mark as Incomplete"
                                    data-lesson-id="${lessonId}"
                                    data-action-url="/tracker/unmark_complete/${lessonId}/"
                                    data-current-status="completed">
                                <i class="fas fa-check-circle me-1"></i> Completed
                            </button>
                        `;
                        listItem.classList.add('completed-lesson');
                    } else {
                        actionsContainer.innerHTML = `
                            <button type="button" 
                                    class="btn btn-sm btn-primary mark-complete-btn lesson-toggle-btn" 
                                    data-lesson-id="${lessonId}"
                                    data-action-url="/tracker/mark_complete/${lessonId}/"
                                    data-current-status="incomplete">
                                <i class="fas fa-check me-1"></i>Mark Complete
                            </button>
                        `;
                        listItem.classList.remove('completed-lesson');
                    }
                    
                    // Update the rest of the dashboard UI using the returned context
                    if (data.context) {
                        updateDashboardUI(data.context);
                    }
                    // Show success toast
                    if(data.message) {
                        showCustomToast(data.message, 'success');
                    }
                } else {
                    throw new Error(data.message || 'Failed to update lesson status.');
                }
            })
            .catch(error => {
                console.error('Error updating lesson status:', error);
                // Show error toast
                showCustomToast(error.message || 'Could not update lesson status.', 'error');
                
                // Revert button and style
                if (isCompleting) {
                     actionsContainer.innerHTML = `
                        <button type="button" 
                                class="btn btn-sm btn-primary mark-complete-btn lesson-toggle-btn" 
                                data-lesson-id="${lessonId}"
                                data-action-url="/tracker/mark_complete/${lessonId}/"
                                data-current-status="incomplete">
                            <i class="fas fa-check me-1"></i>Mark Complete
                        </button>
                    `;
                    listItem.classList.remove('completed-lesson');
                } else {
                    actionsContainer.innerHTML = `
                         <button type="button" 
                                class="btn btn-sm btn-outline-success completed-btn lesson-toggle-btn" 
                                title="Mark as Incomplete"
                                data-lesson-id="${lessonId}"
                                data-action-url="/tracker/unmark_complete/${lessonId}/"
                                data-current-status="completed">
                            <i class="fas fa-check-circle me-1"></i> Completed
                        </button>
                    `;
                   listItem.classList.add('completed-lesson');
                }
            });
        });
    }
});
</script>

{# Custom CSS for Dashboard Enhancements (can be moved to a file later) #}
<style>
    .section-card {
        /* Styles for nested section cards if different from top-level glass-cards */
        /* background: rgba(255,255,255,0.1); Slightly different background for nesting */
        /* border: 1px solid rgba(255,255,255,0.15); */
    }
    .section-title {
        color: var(--heading-color);
    }
    .lesson-list .list-group-item {
        background-color: transparent;
        border-bottom: 1px solid var(--list-item-border-color, rgba(0,0,0,0.05));
        padding: 0.85rem 1.25rem;
        transition: background-color 0.2s ease-in-out;
    }
    .lesson-list .list-group-item:last-child {
        border-bottom: none;
    }
    .lesson-list .list-group-item:hover {
        background-color: var(--list-item-hover-bg, rgba(0,0,0,0.03));
    }
    .lesson-type-badge {
        font-weight: 500;
    }
    .lesson-title-link {
        font-weight: 500;
    }
    .lesson-actions .btn {
        /* Ensure buttons are styled according to visionOS theme */
    }
    .completed-btn {
        /* Specific style for completed button if different from primary */
    }
    .stat-title {
        font-size: 1.1rem;
        font-weight: 500;
        color: var(--text-color);
    }
    .achievement-item .rounded-pill {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    .achievement-item .rounded-pill:hover {
        transform: translateY(-3px);
        box-shadow: var(--card-hover-shadow);
    }
    .achievement-title {
        font-size: 0.7rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 70px; /* Adjust as needed */
    }
    .live-standings-list .loading-stats {
         margin-top: 1rem;
    }
    .live-standing-entry {
        /* background: rgba(var(--bs-light-rgb), 0.7); */
        /* backdrop-filter: blur(5px) saturate(150%); */
        border-radius: 18px; /* Match button/input rounding */
        transition: all 0.2s ease-in-out;
    }
    .live-standing-entry:hover {
        transform: scale(1.02);
        box-shadow: var(--card-hover-shadow);
    }
    .current-user-highlight-dashboard {
        background-color: rgba(var(--bs-primary-rgb), 0.1) !important;
        border: 1px solid rgba(var(--bs-primary-rgb), 0.3);
    }
    .rank-1-dashboard {
        /* Optional: Special border/background for top player in dashboard live stats */
        /* border-left: 3px solid var(--bs-warning) !important; */
    }
    .rank-display-dashboard { min-width: 30px; text-align: center; }
    .username-dashboard { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .points-dashboard .badge { font-size: 0.9em; }

</style>
{% endblock %} 